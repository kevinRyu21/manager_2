# 센서 접속 상태 표시 문제 수정

## 문제 설명

센서가 TCP 서버에 정상적으로 연결되어 데이터를 전송하고 있음에도 불구하고, 매니저 프로그램의 패널이 "접속 대기" 상태로 남아있는 문제가 발생했습니다.

## 원인 분석

### 기존 로직의 문제점

1. **센서 데이터 수신 흐름** (app.py의 `on_data()` 메서드):
   ```
   센서 데이터 수신
   → last_rx 타임스탬프 업데이트 (항상)
   → 빈 데이터(heartbeat)인 경우: 연결 상태 "connected"로 변경
   → 비어있지 않은 데이터: _validate_and_filter_data()로 검증
   → 검증 통과한 데이터(filtered_data)가 있으면: update_data() 호출
   → update_data() 내부에서 연결 상태 "connected"로 변경
   ```

2. **문제가 발생하는 케이스**:
   - 센서가 최초 연결 시 모든 센서 값을 `-1`로 보내는 경우
   - 모든 센서 값이 `<= 0`이지만 아직 3회 반복되지 않은 경우
   - 데이터 검증 로직에서 모든 값이 필터링되어 `filtered_data`가 비어있는 경우

3. **결과**:
   - `filtered_data`가 비어있으면 `update_data()`가 호출되지 않음
   - 연결 상태가 "waiting"에서 "connected"로 변경되지 않음
   - 사용자는 센서가 연결되지 않은 것처럼 보임

### 데이터 검증 로직 (`_validate_and_filter_data()`)

센서 데이터 검증 시 다음 규칙을 적용:
- **최초 `-1` 값 무시**: 첫 번째로 받은 값이 `-1`이면 무시
- **양수 값 즉시 허용**: `> 0` 값은 바로 통과
- **음수/0 값 제한**: 같은 값이 3회 이상 연속으로 와야 허용
- **온도 예외**: `-100` 이상이면 음수도 허용

이러한 검증 로직으로 인해 초기 데이터가 모두 필터링될 수 있습니다.

## 해결 방법

### 수정 내용

센서로부터 **데이터를 수신했다는 사실 자체**가 연결이 성립되었음을 의미하므로, 데이터 검증 결과와 무관하게 연결 상태를 업데이트하도록 수정했습니다.

### 변경된 로직

**app.py의 `on_data()` 메서드** (lines 1876-1882):
```python
# 데이터 검증 및 필터링
filtered_data = self._validate_and_filter_data(key, data)

# 데이터 수신 확인 (필터링 결과와 무관): 연결 상태 업데이트
# 센서로부터 데이터를 받았으므로 연결 상태를 "connected"로 변경
if p._connection_status in ("waiting", "disconnected"):
    p._connection_status = "connected"
    p.header.set_connection_status("connected")
    p.tiles_container.set_connection_status("connected")
    p.status_msg_label.pack_forget()

# 검증 통과한 데이터만 업데이트 및 저장
if filtered_data:
    p.update_data(filtered_data)
    # 로그 기록 (검증 통과한 데이터만)
    self.logs.on_data(sid, peer, filtered_data)
```

**panel.py의 `update_data()` 메서드** (lines 310-311):
```python
# 연결 상태는 app.py의 on_data()에서 처리됨 (중복 제거)
# 이 메서드는 검증된 데이터 업데이트만 담당
```

### 수정 사항 요약

1. **연결 상태 업데이트 위치 변경**:
   - **이전**: `update_data()` 내부에서 처리 (filtered_data가 있을 때만)
   - **이후**: `on_data()`에서 데이터 검증 직후 처리 (filtered_data 여부와 무관)

2. **연결 상태 업데이트 조건**:
   - **이전**: 검증 통과한 데이터가 있을 때만
   - **이후**: 센서로부터 비어있지 않은 데이터를 받았을 때 항상

3. **중복 코드 제거**:
   - `panel.py`의 `update_data()`에서 연결 상태 업데이트 코드 제거
   - 모든 연결 상태 업데이트는 `app.py`의 `on_data()`에서 처리

## 테스트 시나리오

### 1. 초기 연결 시 모든 값이 -1인 경우
- **이전**: "접속 대기" 상태 유지
- **이후**: "연결됨" 상태로 변경 ✓

### 2. 초기 데이터가 0 이하인 경우 (3회 미만)
- **이전**: "접속 대기" 상태 유지
- **이후**: "연결됨" 상태로 변경 ✓

### 3. Heartbeat만 수신하는 경우
- **이전**: "연결됨" 상태로 변경 ✓
- **이후**: "연결됨" 상태로 변경 ✓ (변경 없음)

### 4. 정상 데이터 수신하는 경우
- **이전**: "연결됨" 상태로 변경 ✓
- **이후**: "연결됨" 상태로 변경 ✓ (변경 없음)

### 5. 센서 연결 끊김 후 재연결
- **이전**: 재연결 시 "연결됨" 상태로 변경 ✓
- **이후**: 재연결 시 "연결됨" 상태로 변경 ✓ (변경 없음)

## 기술적 세부사항

### 연결 상태 전환 흐름

```
[센서 미연결]
    ↓
waiting (초기 상태)
    ↓
[센서 연결 + 데이터 수신] ← 수정: 여기서 항상 connected로 변경
    ↓
connected (정상 연결)
    ↓
[타임아웃 or 연결 끊김]
    ↓
disconnected (연결 끊김)
    ↓
[재연결 + 데이터 수신]
    ↓
connected (재연결)
```

### 타임스탬프 업데이트 정책

- **`last_rx` 타임스탬프**: 데이터 수신 시 항상 업데이트 (검증 결과 무관)
- **연결 상태**: 비어있지 않은 데이터 수신 시 "connected"로 변경 (검증 결과 무관)
- **데이터 업데이트**: 검증 통과한 데이터만 패널에 반영
- **로그 기록**: 검증 통과한 데이터만 기록

### 타임아웃 처리

- 연결 타임아웃: 기본 60초 (설정 가능)
- `last_rx` 타임스탬프가 타임아웃보다 오래되면 자동으로 "disconnected"로 변경
- 타임아웃 체크는 별도의 `_status_tick()` 메서드에서 1초마다 확인

## 영향받는 파일

1. **src/tcp_monitor/ui/app.py** (lines 1876-1891):
   - `on_data()` 메서드에 연결 상태 업데이트 로직 추가

2. **src/tcp_monitor/ui/panel.py** (lines 310-311):
   - `update_data()` 메서드에서 중복 연결 상태 업데이트 로직 제거

## 결론

이 수정으로 센서가 데이터를 전송하기만 하면 연결 상태가 즉시 "connected"로 표시되며, 데이터 검증 로직과 연결 상태 표시가 분리되어 더 명확한 동작을 보장합니다.

- **연결 상태**: 데이터 수신 여부로 판단
- **데이터 표시**: 검증 통과한 데이터만 표시
- **로그 기록**: 검증 통과한 데이터만 기록

이를 통해 사용자는 센서 연결 상태를 정확하게 확인할 수 있으며, 데이터 검증 실패가 연결 상태 표시에 영향을 미치지 않습니다.
