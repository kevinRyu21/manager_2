# í•´ì‹œ ì²´ì¸ ê¸°ë°˜ ë¬´ê²°ì„± ê²€ì¦ ì‹œìŠ¤í…œ êµ¬í˜„ ê³„íš

## í˜„ì¬ ìƒíƒœ ë¶„ì„

### ì´ë¯¸ êµ¬í˜„ëœ ê¸°ëŠ¥
| ê¸°ëŠ¥ | íŒŒì¼ | ìƒíƒœ |
|------|------|------|
| ì–¼êµ´ ì¸ì‹ (InsightFace) | safety_detector.py | âœ… ì™„ë£Œ |
| ì•ˆì „ì¥êµ¬ ê°ì§€ (YOLO) | safety_detector.py | âœ… ì™„ë£Œ |
| ì•ˆì „êµìœ¡ í¬ìŠ¤í„° ìˆœì°¨ í‘œì‹œ | safety_education.py | âœ… ì™„ë£Œ |
| ì „ì ì„œëª… ì…ë ¥ | safety_signature.py | âœ… ì™„ë£Œ |
| í†µí•© ì´ë¯¸ì§€ ì €ì¥ (ì–¼êµ´+í¬ìŠ¤í„°+ì„œëª…) | safety_education.py:684 | âœ… ì™„ë£Œ |
| ê°œë³„ SHA256 í•´ì‹œ ìƒì„± | safety_education.py:778 | âœ… ì™„ë£Œ |
| í•´ì‹œ íŒŒì¼ ì €ì¥ (.hash) | safety_education.py:789 | âœ… ì™„ë£Œ |

### ë¯¸êµ¬í˜„ ê¸°ëŠ¥ (íŠ¹í—ˆ ì²­êµ¬í•­ ê´€ë ¨)
| ê¸°ëŠ¥ | ì²­êµ¬í•­ | ìš°ì„ ìˆœìœ„ |
|------|--------|----------|
| í•´ì‹œ ì²´ì¸ ì—°ê²° | ì²­êµ¬í•­ 1(f), 6(g) | ğŸ”´ ë†’ìŒ |
| ë©”íƒ€ë°ì´í„° JSON ìƒì„± | ì²­êµ¬í•­ 2 | ğŸ”´ ë†’ìŒ |
| ZIP ì•„ì¹´ì´ë¸Œ ìƒì„± | ì²­êµ¬í•­ 2 | ğŸŸ¡ ì¤‘ê°„ |
| ì²´ì¸ ë¬´ê²°ì„± ê²€ì¦ | ì²­êµ¬í•­ 9 | ğŸ”´ ë†’ìŒ |
| ë°˜ì¶œ ì•„ì¹´ì´ë¸Œ ìƒì„± | ì²­êµ¬í•­ 3, 7 | ğŸŸ¡ ì¤‘ê°„ |
| ì•ˆì „ì¥êµ¬ ì •ë³´ ê¸°ë¡ | ì²­êµ¬í•­ 4 | ğŸŸ¢ ë‚®ìŒ (ë¶€ë¶„ êµ¬í˜„) |

---

## êµ¬í˜„ ê³„íš

### Phase 1: í•µì‹¬ ëª¨ë“ˆ ìƒì„± (1ì¼)

#### 1.1 ìƒˆ íŒŒì¼ ìƒì„±: `src/tcp_monitor/utils/integrity_manager.py`

```python
"""
ì•ˆì „êµìœ¡ ê¸°ë¡ ë¬´ê²°ì„± ê´€ë¦¬ ëª¨ë“ˆ
- í•´ì‹œ ì²´ì¸ ìƒì„± ë° ê´€ë¦¬
- ê¸°ë¡ ë¬´ê²°ì„± ê²€ì¦
- ë°˜ì¶œ ì•„ì¹´ì´ë¸Œ ìƒì„±
"""

import hashlib
import json
import os
import zipfile
from datetime import datetime
from typing import Dict, List, Optional, Tuple

class IntegrityManager:
    """í•´ì‹œ ì²´ì¸ ê¸°ë°˜ ë¬´ê²°ì„± ê´€ë¦¬ì"""

    GENESIS_HASH = "0" * 64  # ìµœì´ˆ ê¸°ë¡ì˜ ì´ì „ í•´ì‹œ
    HASH_ALGORITHM = "SHA-256"

    def __init__(self, data_dir: str = "safety_photos"):
        self.data_dir = data_dir
        self.chain_file = os.path.join(data_dir, "hash_chain.json")
        self.chain = self._load_chain()

    # === í•´ì‹œ ì²´ì¸ ê´€ë¦¬ ===

    def _load_chain(self) -> Dict:
        """í•´ì‹œ ì²´ì¸ íŒŒì¼ ë¡œë“œ"""
        pass

    def _save_chain(self):
        """í•´ì‹œ ì²´ì¸ íŒŒì¼ ì €ì¥"""
        pass

    def get_last_chain_hash(self) -> str:
        """ë§ˆì§€ë§‰ ì²´ì¸ í•´ì‹œ ë°˜í™˜"""
        pass

    def add_record(self, record_data: Dict) -> Dict:
        """ìƒˆ ê¸°ë¡ ì¶”ê°€ ë° ì²´ì¸ í•´ì‹œ ìƒì„±"""
        pass

    # === í•´ì‹œ ê³„ì‚° ===

    def calculate_file_hash(self, filepath: str) -> str:
        """íŒŒì¼ì˜ SHA-256 í•´ì‹œ ê³„ì‚°"""
        pass

    def calculate_combined_hash(self, file_hashes: Dict[str, str]) -> str:
        """ì—¬ëŸ¬ íŒŒì¼ í•´ì‹œë¥¼ ê²°í•©í•œ í†µí•© í•´ì‹œ ê³„ì‚°"""
        pass

    def calculate_chain_hash(self, combined_hash: str, previous_hash: str) -> str:
        """ì²´ì¸ í•´ì‹œ ê³„ì‚° (í†µí•©í•´ì‹œ + ì´ì „í•´ì‹œ)"""
        pass

    # === ë¬´ê²°ì„± ê²€ì¦ ===

    def verify_record(self, record_id: str) -> Tuple[bool, str]:
        """ë‹¨ì¼ ê¸°ë¡ ë¬´ê²°ì„± ê²€ì¦"""
        pass

    def verify_chain(self, start_id: str = None, end_id: str = None) -> Tuple[bool, List[str]]:
        """í•´ì‹œ ì²´ì¸ ì—°ì†ì„± ê²€ì¦"""
        pass

    def verify_all(self) -> Dict:
        """ì „ì²´ ì‹œìŠ¤í…œ ë¬´ê²°ì„± ê²€ì¦"""
        pass

    # === ë°˜ì¶œ ì•„ì¹´ì´ë¸Œ ===

    def create_export_archive(self, start_date: str, end_date: str,
                              export_path: str, purpose: str) -> Dict:
        """ê¸°ê°„ë³„ ë°˜ì¶œ ì•„ì¹´ì´ë¸Œ ìƒì„±"""
        pass

    def verify_export_archive(self, archive_path: str) -> Tuple[bool, Dict]:
        """ë°˜ì¶œ ì•„ì¹´ì´ë¸Œ ë¬´ê²°ì„± ê²€ì¦"""
        pass
```

#### 1.2 í•´ì‹œ ì²´ì¸ ë°ì´í„° êµ¬ì¡°

```json
// safety_photos/hash_chain.json
{
    "version": "1.0",
    "created": "2025-11-27T09:00:00Z",
    "last_updated": "2025-11-27T15:30:00Z",
    "total_records": 150,
    "genesis_hash": "0000000000000000000000000000000000000000000000000000000000000000",
    "records": [
        {
            "record_id": "REC-20251127-091532-001",
            "timestamp": "2025-11-27T09:15:32Z",
            "person_name": "í™ê¸¸ë™",
            "files": {
                "combined_image": {
                    "filename": "safety_í™ê¸¸ë™_20251127_091532.jpg",
                    "hash": "a1b2c3d4..."
                },
                "metadata": {
                    "filename": "safety_í™ê¸¸ë™_20251127_091532.json",
                    "hash": "e5f6g7h8..."
                }
            },
            "combined_hash": "i9j0k1l2...",
            "previous_chain_hash": "0000000000...",
            "chain_hash": "m3n4o5p6..."
        },
        {
            "record_id": "REC-20251127-092315-002",
            "timestamp": "2025-11-27T09:23:15Z",
            "person_name": "ê¹€ì² ìˆ˜",
            "files": {...},
            "combined_hash": "q7r8s9t0...",
            "previous_chain_hash": "m3n4o5p6...",  // ì´ì „ ê¸°ë¡ì˜ chain_hash
            "chain_hash": "u1v2w3x4..."
        }
    ]
}
```

---

### Phase 2: ê¸°ë¡ ìƒì„± ì‹œìŠ¤í…œ ê°œì„  (1ì¼)

#### 2.1 ë©”íƒ€ë°ì´í„° JSON ìƒì„±

`safety_education.py`ì˜ `_save_combined_image()` í•¨ìˆ˜ ìˆ˜ì •:

```python
def _save_combined_image(self, face_image, signature_image, recognized_name=None,
                         safety_equipment=None):
    """ì–¼êµ´ê³¼ ì„œëª…ì„ í•©ì³ì„œ ì €ì¥ + ë©”íƒ€ë°ì´í„° ë° í•´ì‹œ ì²´ì¸ ìƒì„±"""

    # 1. ê¸°ì¡´ ì´ë¯¸ì§€ ì €ì¥ ë¡œì§ ìœ ì§€
    # ...

    # 2. ë©”íƒ€ë°ì´í„° JSON ìƒì„± (ìƒˆë¡œ ì¶”ê°€)
    metadata = {
        "record_id": f"REC-{timestamp.replace('_', '-')}-{self._get_next_sequence()}",
        "version": "1.0",
        "person": {
            "name": recognized_name,
            "face_embedding_hash": self._get_face_embedding_hash() if face_image else None,
            "identification_confidence": self.last_recognition_confidence
        },
        "safety_equipment": safety_equipment or {
            "helmet": {"worn": False, "color": None},
            "vest": {"worn": False, "color": None},
            "mask": {"worn": False}
        },
        "education": {
            "posters_viewed": len(self.poster_files),
            "total_duration_seconds": self._get_education_duration(),
            "poster_details": self._get_poster_details()
        },
        "timestamps": {
            "education_start": self.education_start_time.isoformat(),
            "education_end": datetime.now().isoformat(),
            "signature_time": self.signature_time.isoformat() if hasattr(self, 'signature_time') else None,
            "record_created": datetime.now().isoformat()
        },
        "system_info": {
            "device_id": self._get_device_id(),
            "software_version": "1.9.6",
            "location": self.config.get("location", "ë¯¸ì„¤ì •")
        }
    }

    # 3. ë©”íƒ€ë°ì´í„° íŒŒì¼ ì €ì¥
    metadata_filepath = filepath.replace('.jpg', '.json')
    with open(metadata_filepath, 'w', encoding='utf-8') as f:
        json.dump(metadata, f, ensure_ascii=False, indent=2)

    # 4. í•´ì‹œ ì²´ì¸ì— ê¸°ë¡ ì¶”ê°€ (ìƒˆë¡œ ì¶”ê°€)
    from ..utils.integrity_manager import IntegrityManager
    integrity = IntegrityManager(save_dir)

    record_data = {
        "record_id": metadata["record_id"],
        "timestamp": metadata["timestamps"]["record_created"],
        "person_name": recognized_name,
        "files": {
            "combined_image": {"filename": filename, "path": filepath},
            "metadata": {"filename": os.path.basename(metadata_filepath), "path": metadata_filepath}
        }
    }

    chain_result = integrity.add_record(record_data)

    # 5. í•´ì‹œ ì •ë³´ ì—…ë°ì´íŠ¸
    metadata["integrity"] = {
        "combined_hash": chain_result["combined_hash"],
        "chain_hash": chain_result["chain_hash"],
        "previous_chain_hash": chain_result["previous_chain_hash"]
    }

    # ë©”íƒ€ë°ì´í„° íŒŒì¼ ì¬ì €ì¥ (í•´ì‹œ ì •ë³´ í¬í•¨)
    with open(metadata_filepath, 'w', encoding='utf-8') as f:
        json.dump(metadata, f, ensure_ascii=False, indent=2)
```

#### 2.2 ì•ˆì „ì¥êµ¬ ì •ë³´ ì—°ë™

`safety_signature.py`ì—ì„œ ì•ˆì „ì¥êµ¬ ê°ì§€ ê²°ê³¼ë¥¼ `safety_education.py`ë¡œ ì „ë‹¬:

```python
# safety_signature.pyì˜ ì„œëª… ì™„ë£Œ ì½œë°±ì—ì„œ
def _on_signature_complete(self):
    result = {
        "face_image": self.captured_face_image,
        "signature_image": self.signature_image,
        "recognized_name": self.recognized_name,
        "safety_equipment": {
            "helmet": {
                "worn": self.last_detection.get("hard_hat", {}).get("detected", False),
                "color": self.last_detection.get("hard_hat", {}).get("color_kr")
            },
            "vest": {
                "worn": self.last_detection.get("safety_vest", {}).get("detected", False),
                "color": self.last_detection.get("safety_vest", {}).get("color_kr")
            },
            "mask": {
                "worn": self.last_detection.get("mask", {}).get("detected", False)
            }
        }
    }
    self.on_complete_callback(result)
```

---

### Phase 3: ë¬´ê²°ì„± ê²€ì¦ UI (0.5ì¼)

#### 3.1 ì„¤ì • ë©”ë‰´ì— ê²€ì¦ ê¸°ëŠ¥ ì¶”ê°€

`app.py`ì˜ ë©”ë‰´ì— ì¶”ê°€:

```python
# ì„¤ì • ë©”ë‰´
settings_menu.add_command(
    label="ğŸ”’ ë¬´ê²°ì„± ê²€ì¦",
    command=self._show_integrity_verification
)

settings_menu.add_command(
    label="ğŸ“¦ ê¸°ë¡ ë°˜ì¶œ",
    command=self._show_export_dialog
)
```

#### 3.2 ë¬´ê²°ì„± ê²€ì¦ ë‹¤ì´ì–¼ë¡œê·¸

ìƒˆ íŒŒì¼: `src/tcp_monitor/ui/integrity_verification.py`

```python
class IntegrityVerificationDialog:
    """ë¬´ê²°ì„± ê²€ì¦ ëŒ€í™”ìƒì"""

    def __init__(self, parent):
        self.dialog = tk.Toplevel(parent)
        self.dialog.title("ë¬´ê²°ì„± ê²€ì¦")
        self._create_ui()

    def _create_ui(self):
        # ê²€ì¦ ë²”ìœ„ ì„ íƒ (ì „ì²´ / ê¸°ê°„ / íŠ¹ì • ê¸°ë¡)
        # ê²€ì¦ ì‹¤í–‰ ë²„íŠ¼
        # ê²°ê³¼ í‘œì‹œ ì˜ì—­ (íŠ¸ë¦¬ë·°)
        # ìƒì„¸ ê²°ê³¼ ë³´ê¸°
        pass

    def _verify_all(self):
        """ì „ì²´ ê²€ì¦ ì‹¤í–‰"""
        from ..utils.integrity_manager import IntegrityManager
        integrity = IntegrityManager()
        result = integrity.verify_all()
        self._show_result(result)

    def _show_result(self, result):
        """ê²€ì¦ ê²°ê³¼ í‘œì‹œ"""
        # ì „ì²´ ê¸°ë¡ ìˆ˜
        # ê²€ì¦ í†µê³¼ ìˆ˜
        # ê²€ì¦ ì‹¤íŒ¨ ìˆ˜ (ì¡°ì‘/ì‚­ì œ íƒì§€)
        # ìƒì„¸ ì˜¤ë¥˜ ëª©ë¡
        pass
```

---

### Phase 4: ë°˜ì¶œ ì•„ì¹´ì´ë¸Œ ì‹œìŠ¤í…œ (0.5ì¼)

#### 4.1 ë°˜ì¶œ ë‹¤ì´ì–¼ë¡œê·¸

ìƒˆ íŒŒì¼: `src/tcp_monitor/ui/export_archive.py`

```python
class ExportArchiveDialog:
    """ë°˜ì¶œ ì•„ì¹´ì´ë¸Œ ìƒì„± ëŒ€í™”ìƒì"""

    def __init__(self, parent):
        self.dialog = tk.Toplevel(parent)
        self.dialog.title("ê¸°ë¡ ë°˜ì¶œ")
        self._create_ui()

    def _create_ui(self):
        # ê¸°ê°„ ì„ íƒ (ì‹œì‘ì¼ ~ ì¢…ë£Œì¼)
        # ë°˜ì¶œ ëª©ì  ì…ë ¥
        # ì €ì¥ ìœ„ì¹˜ ì„ íƒ
        # ë°˜ì¶œ ì‹¤í–‰ ë²„íŠ¼
        # ì§„í–‰ ìƒíƒœ í‘œì‹œ
        pass

    def _create_archive(self):
        """ë°˜ì¶œ ì•„ì¹´ì´ë¸Œ ìƒì„±"""
        from ..utils.integrity_manager import IntegrityManager
        integrity = IntegrityManager()

        result = integrity.create_export_archive(
            start_date=self.start_date.get(),
            end_date=self.end_date.get(),
            export_path=self.export_path.get(),
            purpose=self.purpose.get()
        )

        self._show_result(result)
```

#### 4.2 ë°˜ì¶œ ì•„ì¹´ì´ë¸Œ êµ¬ì¡°

```
export_202511_20251130_143022.zip
â”œâ”€â”€ records/
â”‚   â”œâ”€â”€ safety_í™ê¸¸ë™_20251101_081532.jpg
â”‚   â”œâ”€â”€ safety_í™ê¸¸ë™_20251101_081532.json
â”‚   â”œâ”€â”€ safety_ê¹€ì² ìˆ˜_20251101_092145.jpg
â”‚   â”œâ”€â”€ safety_ê¹€ì² ìˆ˜_20251101_092145.json
â”‚   â””â”€â”€ ...
â”œâ”€â”€ chain_verification/
â”‚   â”œâ”€â”€ hash_chain_202511.json      # í•´ë‹¹ ì›” ì²´ì¸ ë°ì´í„°
â”‚   â”œâ”€â”€ integrity_report.json       # ê²€ì¦ ê²°ê³¼ ë³´ê³ ì„œ
â”‚   â””â”€â”€ verify_tool.py              # ë…ë¦½ ê²€ì¦ ë„êµ¬
â”œâ”€â”€ summary/
â”‚   â”œâ”€â”€ education_summary.csv       # êµìœ¡ ì´ìˆ˜ í˜„í™©
â”‚   â””â”€â”€ equipment_summary.csv       # ì•ˆì „ì¥êµ¬ ì°©ìš© í˜„í™©
â””â”€â”€ export_manifest.json            # ë°˜ì¶œ ì •ë³´
```

---

## êµ¬í˜„ ìš°ì„ ìˆœìœ„ ë° ì¼ì •

| ë‹¨ê³„ | ì‘ì—… | ì˜ˆìƒ ì‹œê°„ | ìš°ì„ ìˆœìœ„ |
|------|------|----------|----------|
| **Phase 1.1** | IntegrityManager í´ë˜ìŠ¤ ê¸°ë³¸ êµ¬ì¡° | 2ì‹œê°„ | ğŸ”´ |
| **Phase 1.2** | í•´ì‹œ ì²´ì¸ ë¡œì§ êµ¬í˜„ | 3ì‹œê°„ | ğŸ”´ |
| **Phase 2.1** | ë©”íƒ€ë°ì´í„° JSON ìƒì„± | 2ì‹œê°„ | ğŸ”´ |
| **Phase 2.2** | ì•ˆì „ì¥êµ¬ ì •ë³´ ì—°ë™ | 1ì‹œê°„ | ğŸŸ¡ |
| **Phase 3** | ê²€ì¦ UI | 3ì‹œê°„ | ğŸŸ¡ |
| **Phase 4** | ë°˜ì¶œ ì•„ì¹´ì´ë¸Œ | 3ì‹œê°„ | ğŸŸ¡ |

**ì´ ì˜ˆìƒ ì‹œê°„: 14ì‹œê°„ (ì•½ 2ì¼)**

---

## íŒŒì¼ êµ¬ì¡° ë³€ê²½

```
src/tcp_monitor/
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ integrity_manager.py    # ìƒˆë¡œ ìƒì„±
â”œâ”€â”€ ui/
â”‚   â”œâ”€â”€ integrity_verification.py  # ìƒˆë¡œ ìƒì„±
â”‚   â”œâ”€â”€ export_archive.py          # ìƒˆë¡œ ìƒì„±
â”‚   â”œâ”€â”€ safety_education.py        # ìˆ˜ì •
â”‚   â”œâ”€â”€ safety_signature.py        # ìˆ˜ì •
â”‚   â””â”€â”€ app.py                     # ìˆ˜ì • (ë©”ë‰´ ì¶”ê°€)
```

---

## í…ŒìŠ¤íŠ¸ ê³„íš

### ë‹¨ìœ„ í…ŒìŠ¤íŠ¸

```python
# tests/test_integrity_manager.py

def test_hash_calculation():
    """í•´ì‹œ ê³„ì‚° ì •í™•ì„± í…ŒìŠ¤íŠ¸"""
    pass

def test_chain_hash_generation():
    """ì²´ì¸ í•´ì‹œ ìƒì„± í…ŒìŠ¤íŠ¸"""
    pass

def test_record_verification():
    """ê¸°ë¡ ê²€ì¦ í…ŒìŠ¤íŠ¸"""
    pass

def test_chain_integrity():
    """ì²´ì¸ ë¬´ê²°ì„± í…ŒìŠ¤íŠ¸"""
    pass

def test_tampering_detection():
    """ì¡°ì‘ íƒì§€ í…ŒìŠ¤íŠ¸"""
    pass

def test_export_archive():
    """ë°˜ì¶œ ì•„ì¹´ì´ë¸Œ í…ŒìŠ¤íŠ¸"""
    pass
```

### ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸

1. **ì •ìƒ ì¼€ì´ìŠ¤**: 100ê°œ ê¸°ë¡ ìƒì„± â†’ ì „ì²´ ê²€ì¦ â†’ ëª¨ë‘ í†µê³¼
2. **íŒŒì¼ ë³€ì¡°**: ì¤‘ê°„ ê¸°ë¡ ì´ë¯¸ì§€ ìˆ˜ì • â†’ ê²€ì¦ â†’ í•´ë‹¹ ê¸°ë¡ íƒì§€
3. **ê¸°ë¡ ì‚­ì œ**: ì¤‘ê°„ ê¸°ë¡ ì‚­ì œ â†’ ê²€ì¦ â†’ ì²´ì¸ ë‹¨ì ˆ íƒì§€
4. **ê¸°ë¡ ì‚½ì…**: ê³¼ê±° ë‚ ì§œë¡œ ê¸°ë¡ ì‚½ì… ì‹œë„ â†’ ê²€ì¦ â†’ ì²´ì¸ ë¶ˆì¼ì¹˜ íƒì§€
5. **ë°˜ì¶œ ê²€ì¦**: ì•„ì¹´ì´ë¸Œ ìƒì„± â†’ ì™¸ë¶€ì—ì„œ ê²€ì¦ ë„êµ¬ë¡œ ê²€ì¦ â†’ í†µê³¼

---

## êµ¬í˜„ ì‹œì‘ ëª…ë ¹

êµ¬í˜„ì„ ì‹œì‘í•˜ë ¤ë©´ ë‹¤ìŒê³¼ ê°™ì´ ìš”ì²­í•˜ì„¸ìš”:

```
"Phase 1ë¶€í„° êµ¬í˜„ ì‹œì‘í•´ ì¤˜"
```

ë˜ëŠ” íŠ¹ì • ë‹¨ê³„ë§Œ:

```
"IntegrityManager í´ë˜ìŠ¤ë§Œ ë¨¼ì € êµ¬í˜„í•´ ì¤˜"
```
