# 안전화(Boots) 감지 모델 학습 및 통합 가이드

## 개요

기존 SH17 데이터셋 기반 YOLOv10 모델의 `shoes` 클래스는 안전화와 일반 신발(슬리퍼 등)을 구분하지 못하는 문제가 있었습니다. 이를 해결하기 위해 Construction-PPE 데이터셋으로 별도의 안전화 감지 모델을 학습하고 통합했습니다.

## 1. 환경 준비

### 1.1 필수 패키지 설치

```bash
# 가상환경 활성화
source venv/bin/activate

# ultralytics 설치 (YOLOv10 학습용)
pip install ultralytics
```

### 1.2 디렉토리 구조

```
1.9.8/
├── datasets/
│   ├── images/
│   │   ├── train/
│   │   ├── val/
│   │   └── test/
│   ├── labels/
│   │   ├── train/
│   │   ├── val/
│   │   └── test/
│   └── construction-ppe.yaml
├── models/
│   ├── yolo10x.pt              # 메인 PPE 모델
│   └── construction-ppe.pt     # 안전화 감지 모델 (학습 후 생성)
├── runs/
│   └── detect/
│       └── construction-ppe/
│           └── weights/
│               ├── best.pt
│               └── last.pt
└── train_boots_model.py
```

## 2. 데이터셋 다운로드

### 2.1 Construction-PPE 데이터셋

Ultralytics Hub에서 제공하는 Construction-PPE 데이터셋을 사용합니다.

```bash
cd /home/garam/바탕화면/code/1.9.8

# 데이터셋 다운로드
curl -L "https://universe.roboflow.com/ds/oRHdcgJvnB?key=OUqhFngVOV" -o construction-ppe.zip

# 압축 해제
unzip construction-ppe.zip -d datasets/
```

### 2.2 데이터셋 정보

- **훈련 이미지**: 1,132장
- **검증 이미지**: 143장
- **테스트 이미지**: 72장
- **클래스 (11개)**:
  - 0: helmet
  - 1: gloves
  - 2: vest
  - 3: boots ← 안전화
  - 4: goggles
  - 5: none
  - 6: Person
  - 7: no_helmet
  - 8: no_goggle
  - 9: no_gloves
  - 10: no_boots ← 안전화 미착용

## 3. 데이터셋 설정 파일

### 3.1 construction-ppe.yaml 생성

```yaml
# datasets/construction-ppe.yaml
path: /home/garam/바탕화면/code/1.9.8/datasets
train: images/train
val: images/val
test: images/test

names:
  0: helmet
  1: gloves
  2: vest
  3: boots
  4: goggles
  5: none
  6: Person
  7: no_helmet
  8: no_goggle
  9: no_gloves
  10: no_boots
```

**주의**: `path`는 절대경로로 지정해야 합니다. 다른 컴퓨터에서는 해당 경로를 수정하세요.

## 4. 학습 스크립트

### 4.1 train_boots_model.py

```python
#!/usr/bin/env python3
"""
Construction-PPE 데이터셋으로 YOLOv10 안전화 감지 모델 학습
"""

import os
import sys

# 현재 디렉토리를 작업 디렉토리로 설정
os.chdir('/home/garam/바탕화면/code/1.9.8')

from ultralytics import YOLO

def main():
    # 기본 모델 로드 (YOLOv10n - 가벼운 모델)
    print("Loading base model: yolov10n.pt")
    model = YOLO('yolov10n.pt')

    # 데이터셋 경로
    data_yaml = 'datasets/construction-ppe.yaml'

    print(f"Training with dataset: {data_yaml}")
    print("=" * 50)

    # 학습 시작
    results = model.train(
        data=data_yaml,
        epochs=50,              # 학습 에폭 수
        imgsz=640,              # 입력 이미지 크기
        batch=8,                # 배치 크기 (메모리에 따라 조절)
        device='cpu',           # GPU 사용시 'cuda' 또는 '0'
        project='runs/detect',  # 결과 저장 경로
        name='construction-ppe',
        exist_ok=True,
        patience=10,            # 조기 종료 patience
        save=True,
        pretrained=True,
        deterministic=True,
        seed=42
    )

    print("=" * 50)
    print("Training completed!")
    print(f"Best model saved at: runs/detect/construction-ppe/weights/best.pt")

    # 최적 모델을 models 폴더로 복사
    import shutil
    src = 'runs/detect/construction-ppe/weights/best.pt'
    dst = 'models/construction-ppe.pt'
    if os.path.exists(src):
        shutil.copy(src, dst)
        print(f"Model copied to: {dst}")

if __name__ == '__main__':
    main()
```

### 4.2 학습 실행

```bash
# 가상환경에서 실행
./venv/bin/python3 train_boots_model.py
```

**참고**:
- CPU에서 약 6-7시간 소요
- GPU(CUDA) 사용시 약 30분-1시간 소요
- GPU 사용시 `device='cuda'` 또는 `device='0'`으로 변경

## 5. 학습 결과

### 5.1 최종 성능 (50 Epochs)

| 지표 | 값 |
|------|-----|
| Precision | 70.0% |
| Recall | 46.2% |
| mAP50 | 51.3% |
| mAP50-95 | 26.9% |

### 5.2 학습 개선 추이

| Epoch | mAP50 | mAP50-95 |
|-------|-------|----------|
| 1 | 16.6% | 8.6% |
| 10 | 38.5% | 19.2% |
| 25 | 48.2% | 24.1% |
| 50 | 51.3% | 26.9% |

### 5.3 생성된 파일

```
runs/detect/construction-ppe/
├── weights/
│   ├── best.pt          # 최적 모델 (5.5MB)
│   └── last.pt          # 마지막 모델
├── results.csv          # 학습 기록
├── results.png          # 학습 그래프
├── confusion_matrix.png # 혼동 행렬
└── ...
```

## 6. PPE 감지기 통합

### 6.1 detector.py 수정 사항

#### 6.1.1 클래스 매핑 수정

```python
# PPE_CLASSES에서 shoes 매핑 제거 (주석 처리)
PPE_CLASSES = {
    # ...
    # 'shoes': 'boots',  # SH17 shoes는 안전화 구분 불가 - construction-ppe 모델 사용
    # ...
}

# Construction-PPE 모델 클래스 매핑 추가
CONSTRUCTION_PPE_CLASSES = {
    'boots': 'boots',
    'no_boots': 'no_boots',
}
```

#### 6.1.2 초기화 함수 수정

```python
def __init__(self, ...):
    # ...
    self.boots_model = None  # 안전화 감지 전용 모델
    self.boots_class_names = {}

    # ... 메인 모델 로드 ...

    # 안전화 감지 모델 로드 (Construction-PPE)
    boots_model_path = self._find_boots_model_path()
    if boots_model_path and os.path.exists(boots_model_path):
        try:
            print(f"[PPE] 안전화 모델 로딩: {boots_model_path}")
            self.boots_model = YOLO(boots_model_path)
            self.boots_class_names = self.boots_model.names
            print(f"[PPE] 안전화 모델 로드 완료")
        except Exception as e:
            print(f"[PPE] 안전화 모델 로드 실패: {e}")
```

#### 6.1.3 모델 경로 탐색 함수 추가

```python
def _find_boots_model_path(self) -> Optional[str]:
    """안전화 모델 경로 자동 탐색"""
    possible_paths = [
        'models/construction-ppe.pt',
        './models/construction-ppe.pt',
        '../models/construction-ppe.pt',
    ]

    base_dir = get_base_dir()
    for path in possible_paths:
        full_path = os.path.join(base_dir, path)
        if os.path.exists(full_path):
            return full_path

    return None
```

#### 6.1.4 detect 함수 수정

```python
def detect(self, frame: np.ndarray) -> List[PersonDetection]:
    # ... 메인 모델 감지 ...

    # 메인 모델에서 boots 제외
    elif normalized_name in ['helmet', 'glasses', 'mask', 'gloves', 'vest']:
        ppe_items.append((normalized_name, bbox))

    # 안전화 모델로 boots 감지 (별도 모델)
    if self.boots_model is not None:
        try:
            boots_results = self.boots_model(
                frame,
                conf=self.confidence_threshold,
                iou=self.iou_threshold,
                verbose=False
            )
            for result in boots_results:
                boxes = result.boxes
                if boxes is None:
                    continue

                for box in boxes:
                    x1, y1, x2, y2 = map(int, box.xyxy[0].tolist())
                    conf = float(box.conf[0])
                    cls_id = int(box.cls[0])
                    cls_name = self.boots_class_names.get(cls_id, str(cls_id))

                    # boots 클래스만 처리 (no_boots는 무시)
                    if cls_name == 'boots':
                        bbox = BoundingBox(
                            x1=x1, y1=y1, x2=x2, y2=y2,
                            confidence=conf,
                            class_id=cls_id,
                            class_name=cls_name
                        )
                        ppe_items.append(('boots', bbox))
        except Exception as e:
            print(f"[PPE] 안전화 감지 오류: {e}")

    # ... 나머지 처리 ...
```

## 7. 다른 컴퓨터에서 재현하기

### 7.1 빠른 배포 (학습된 모델 사용)

학습된 모델만 복사하는 경우:

```bash
# 1. construction-ppe.pt 파일을 models/ 폴더에 복사
cp construction-ppe.pt /path/to/1.9.8/models/

# 2. detector.py가 업데이트되어 있는지 확인
# 3. 애플리케이션 재시작
```

### 7.2 처음부터 학습하기

```bash
# 1. 가상환경 설정
python3 -m venv venv
source venv/bin/activate
pip install ultralytics torch torchvision

# 2. 데이터셋 다운로드
curl -L "https://universe.roboflow.com/ds/oRHdcgJvnB?key=OUqhFngVOV" -o construction-ppe.zip
unzip construction-ppe.zip -d datasets/

# 3. YAML 파일의 path 수정
# datasets/construction-ppe.yaml의 path를 현재 경로로 수정

# 4. 학습 실행
python3 train_boots_model.py

# 5. 모델 복사 (자동으로 되지 않은 경우)
cp runs/detect/construction-ppe/weights/best.pt models/construction-ppe.pt
```

## 8. 문제 해결

### 8.1 CUDA 메모리 부족

```python
# train_boots_model.py에서 배치 크기 줄이기
batch=4,  # 또는 2
```

### 8.2 모델 로드 실패

```bash
# PyTorch 버전 확인
python3 -c "import torch; print(torch.__version__)"

# ultralytics 재설치
pip uninstall ultralytics
pip install ultralytics
```

### 8.3 데이터셋 경로 오류

```yaml
# construction-ppe.yaml의 path를 절대경로로 수정
path: /your/absolute/path/to/datasets
```

## 9. 참고 자료

- **Construction-PPE Dataset**: https://universe.roboflow.com/roboflow-universe-projects/construction-site-safety
- **Ultralytics YOLOv10**: https://docs.ultralytics.com/models/yolov10/
- **YOLOv10 GitHub**: https://github.com/THU-MIG/yolov10

---

**작성일**: 2024-12-24
**작성자**: Claude Code
**버전**: GARAMe Manager v1.9.8
