# 센서 시뮬레이터 사용 가이드

GARAMe Manager v2.1.0 센서 테스트 도구

---

## 개요

센서 시뮬레이터는 실제 센서 하드웨어 없이 GARAMe Manager의 모든 기능을 테스트할 수 있는 도구입니다.
TCP v2.0 프로토콜을 완벽하게 지원하며, 다양한 위험 시나리오를 시뮬레이션할 수 있습니다.

**파일명**: `sensor_simulator.py`

---

## 주요 기능

### 1. 다중 센서 동시 연결
- **센서 ID 1-4**: 최대 4개 센서 동시 시뮬레이션
- **독립적 제어**: 각 센서마다 다른 시나리오 선택 가능
- **개별 연결 관리**: 센서별 연결/종료 독립 제어

### 2. 13가지 시나리오 프리셋

#### 정상 시나리오
- **정상**: 모든 센서 값이 정상 범위 내

#### 화재 시나리오 (4단계)
- **화재 레벨1 (주의)**: 초기 화재 징후
  - CO2: 800ppm, CO: 15ppm, 연기: 15%, 온도: 25°C
- **화재 레벨2 (경계)**: 화재 진행 중
  - CO2: 1500ppm, CO: 30ppm, 연기: 30%, 온도: 30°C
- **화재 레벨3 (경고)**: 심각한 화재
  - CO2: 3000ppm, CO: 60ppm, 연기: 50%, 온도: 40°C
- **화재 레벨4 (위험)**: 긴급 대피 필요
  - CO2: 5000ppm, CO: 100ppm, 연기: 70%, 온도: 60°C

#### 가스 및 질식 시나리오
- **CO2 질식 위험**: CO2 5000ppm 이상
- **CO 중독 위험**: CO 100ppm 이상
- **산소 부족**: O2 18% 이하
- **H2S 황화수소 위험**: H2S 15ppm 이상
- **CH4 가연성가스 위험**: CH4 60%LEL 이상

#### 기타 시나리오
- **연기 감지**: 연기 센서 60% 이상
- **누수 감지**: 누수 센서 활성화 (water=1)
- **랜덤**: 모든 센서 값 무작위 생성

### 3. 실시간 센서 데이터 생성

#### 9개 센서 지원
| 센서 | 단위 | 정상 범위 | 설명 |
|------|------|-----------|------|
| CO2 | ppm | 350-450 | 이산화탄소 |
| CO | ppm | 0-5 | 일산화탄소 |
| O2 | % | 20.4-21.4 | 산소 |
| H2S | ppm | 0-1 | 황화수소 |
| CH4 | %LEL | 0-5 | 메탄/가연성 가스 |
| 온도 | °C | 18-22 | 온도 |
| 습도 | %RH | 40-60 | 습도 |
| 연기 | % | 0-5 | 연기 농도 |
| 누수 | 0/1 | 0 | 누수 감지 |

#### 랜덤 변동
각 시나리오의 센서 값은 실제 환경처럼 약간씩 변동됩니다.
- 예: 화재 레벨1에서 CO2는 800±50ppm 범위로 변동

### 4. TCP v2.0 프로토콜 지원

#### Hello 핸드셰이크
```json
{
  "type": "hello",
  "id": "1",
  "msg_id": "uuid",
  "timestamp": 1706403600.0,
  "protocol_version": "2.0",
  "device_type": "sensor",
  "firmware_version": "SIMULATOR-1.0",
  "capabilities": ["sensor_update", "heartbeat"],
  "supported_sensors": ["co2", "co", "o2", "h2s", "ch4", "temperature", "humidity", "smoke", "water"]
}
```

#### Sensor Update
```json
{
  "type": "sensor_update",
  "id": "1",
  "msg_id": "uuid",
  "timestamp": 1706403600.0,
  "protocol_version": "2.0",
  "sequence": 0,
  "password": "1234",
  "version": "SIMULATOR-1.0",
  "data": {
    "co2": 800.0,
    "co": 15.0,
    "o2": 20.5,
    "h2s": 0.5,
    "ch4": 10.0,
    "temperature": 25.0,
    "humidity": 50.0,
    "smoke": 15.0,
    "water": 0
  }
}
```

---

## 사용 방법

### 1. Manager 실행

```bash
cd /home/garam/다운로드/manager_2-2.1.0
python3 main.py
```

Manager가 정상적으로 실행되고 TCP 서버가 9000 포트에서 대기 중인지 확인합니다.

로그에 다음 메시지가 표시되어야 합니다:
```
[TcpServer v2.0] listening on 0.0.0.0:9000 (TCP)
```

### 2. 시뮬레이터 실행

**별도 터미널**에서 시뮬레이터를 실행합니다:

```bash
cd /home/garam/다운로드/manager_2-2.1.0
python3 sensor_simulator.py
```

### 3. GUI 사용법

#### 상단 설정 패널
1. **서버 주소**: Manager가 실행 중인 IP (기본: 127.0.0.1)
2. **포트**: TCP 포트 번호 (기본: 9000)
3. **전송주기(초)**: 센서 데이터 전송 간격 (기본: 1.0초)

#### 센서 제어 패널 (4개)
각 센서 패널에는 다음 컨트롤이 있습니다:

1. **상태 표시**:
   - `● 연결 안됨` (빨간색)
   - `● 연결됨` (초록색)

2. **시나리오 선택**:
   - 드롭다운에서 테스트할 시나리오 선택

3. **버튼**:
   - **연결**: 센서를 Manager에 연결
   - **연결 종료**: 연결 해제
   - **전송 시작**: 선택한 시나리오로 데이터 전송 시작

#### 로그 패널
- 실시간 연결 상태 및 전송 로그 표시
- **로그 지우기** 버튼으로 로그 초기화

---

## 사용 예시

### 예시 1: 단일 센서 정상 모니터링

**목적**: 센서 1번으로 정상 상태 테스트

**절차**:
1. Manager 실행
2. 시뮬레이터 실행
3. 센서 1 패널에서:
   - 시나리오: "정상" 선택
   - "연결" 클릭
   - "전송 시작" 클릭
4. Manager에서 센서 1번 타일 확인
5. 모든 센서 값이 정상 범위에 있는지 확인

**예상 결과**:
- 모든 센서 값이 녹색으로 표시
- 경보 없음

---

### 예시 2: 화재 진행 단계 테스트

**목적**: 화재가 점진적으로 악화되는 상황 시뮬레이션

**절차**:
1. 센서 1 패널:
   - 시나리오: "정상" 선택
   - 연결 및 전송 시작
2. 약 30초 후, 센서 1 패널:
   - 시나리오: "화재 레벨1 (주의)"로 변경
   - (이미 전송 중이므로 자동 적용)
3. 약 30초 후:
   - 시나리오: "화재 레벨2 (경계)"
4. 약 30초 후:
   - 시나리오: "화재 레벨3 (경고)"
5. Manager의 화재 감시 패널 관찰

**예상 결과**:
- 화재 레벨이 단계적으로 상승
- 레벨 3 도달 시 화재 경보 다이얼로그 표시
- 경보음 재생

---

### 예시 3: 다중 센서 동시 위험 상황

**목적**: 여러 센서에서 동시에 다른 위험 발생

**절차**:
1. 센서 1 패널:
   - 시나리오: "화재 레벨3 (경고)"
   - 연결 및 전송 시작
2. 센서 2 패널:
   - 시나리오: "CO2 질식 위험"
   - 연결 및 전송 시작
3. 센서 3 패널:
   - 시나리오: "누수 감지"
   - 연결 및 전송 시작
4. 센서 4 패널:
   - 시나리오: "정상"
   - 연결 및 전송 시작
5. Manager에서 "센서전체보기" 버튼 클릭

**예상 결과**:
- 센서 1: 화재 경보 (빨간색)
- 센서 2: CO2 경보 (주황색)
- 센서 3: 누수 경보 (파란색)
- 센서 4: 정상 (초록색)
- 다중 경보음 재생

---

### 예시 4: 가스 누출 감지

**목적**: 가연성 가스 누출 및 황화수소 검출 테스트

**절차**:
1. 센서 1:
   - 시나리오: "CH4 가연성가스 위험"
   - 연결 및 전송 시작
2. 센서 2:
   - 시나리오: "H2S 황화수소 위험"
   - 연결 및 전송 시작

**예상 결과**:
- CH4 센서 값이 60%LEL 이상 (빨간색)
- H2S 센서 값이 15ppm 이상 (빨간색)
- "가스 누출 감지" 경보음

---

### 예시 5: 랜덤 테스트

**목적**: 예측 불가능한 센서 값으로 시스템 안정성 테스트

**절차**:
1. 모든 센서 (1-4):
   - 시나리오: "랜덤" 선택
   - 모두 연결 및 전송 시작
2. 약 5분간 관찰

**예상 결과**:
- 센서 값이 무작위로 변동
- 경보가 무작위로 발생/해제
- UI가 안정적으로 작동
- 메모리 누수 없음

---

## 고급 사용법

### 전송 주기 조절

**기본 설정**: 1.0초

**용도별 권장 값**:
- **빠른 테스트**: 0.5초
- **정상 모니터링**: 1.0초 (기본)
- **장기 안정성 테스트**: 5.0초
- **네트워크 부하 테스트**: 0.1초

**변경 방법**:
상단 "전송주기(초)" 필드에 값을 입력한 후, "전송 시작" 버튼을 다시 클릭합니다.

### 시나리오 동적 전환

전송 중에도 시나리오를 변경할 수 있습니다:
1. 전송이 진행 중인 센서의 시나리오 드롭다운 변경
2. 자동으로 새 시나리오 적용
3. "전송 시작" 버튼을 다시 클릭할 필요 없음

**예시**: 정상 → 화재 레벨1 → 화재 레벨2 → 화재 레벨3 순차 전환

---

## 문제 해결

### 연결 실패

**증상**: "연결 실패" 메시지

**원인**:
- Manager가 실행되지 않음
- 포트 번호 불일치
- 방화벽 차단

**해결**:
1. Manager가 실행 중인지 확인
   ```bash
   ps aux | grep main.py
   ```
2. Manager 로그에서 TCP 서버 포트 확인
   ```
   [TcpServer v2.0] listening on 0.0.0.0:9000 (TCP)
   ```
3. 방화벽 규칙 확인
   ```bash
   sudo ufw status
   sudo ufw allow 9000/tcp
   ```

### 데이터가 Manager에 표시되지 않음

**증상**: 연결은 성공했지만 센서 데이터가 표시되지 않음

**원인**:
- 센서 ID 중복
- 프로토콜 버전 불일치

**해결**:
1. 각 센서가 서로 다른 ID를 사용하는지 확인
2. Manager 로그에서 프로토콜 오류 확인
3. 시뮬레이터를 재시작

### 전송이 중단됨

**증상**: 전송이 시작되었다가 곧 중단됨

**원인**:
- 네트워크 연결 끊김
- Manager가 종료됨

**해결**:
1. "연결 종료" → "연결" → "전송 시작" 순서로 재연결
2. Manager를 재시작

---

## 로그 분석

### 정상 로그 예시

```
[12:34:56] [센서 1] 연결 성공: 127.0.0.1:9000
[12:34:56] [센서 1] 데이터 전송 시작
[12:34:56] [센서 1] 시나리오: 정상
```

### 오류 로그 예시

```
[12:34:56] [센서 1] 연결 실패: [Errno 111] Connection refused
[12:34:56] [센서 1] 전송 오류: [Errno 32] Broken pipe
```

---

## 성능 벤치마크

### 테스트 환경
- Ubuntu 22.04 LTS
- Python 3.13
- Intel Core i7-8550U
- 16GB RAM

### 결과
| 센서 수 | 전송 주기 | CPU 사용률 | 메모리 사용 |
|---------|-----------|------------|-------------|
| 1개 | 1.0초 | 1-2% | 50MB |
| 2개 | 1.0초 | 2-3% | 60MB |
| 4개 | 1.0초 | 3-5% | 80MB |
| 4개 | 0.1초 | 8-12% | 90MB |

**결론**: 4개 센서를 0.1초 간격으로 전송해도 시스템 부하가 낮습니다.

---

## 코드 구조

### 주요 클래스

#### SensorData
센서 데이터를 저장하는 데이터 클래스
```python
@dataclass
class SensorData:
    co2: Optional[float] = None
    co: Optional[float] = None
    # ... 기타 센서 필드
```

#### SensorClient
TCP 클라이언트 및 데이터 전송 관리
```python
class SensorClient:
    def connect(self) -> bool
    def disconnect(self)
    def start_sending(self)
    def _generate_sensor_data(self, scenario: str) -> SensorData
```

#### SensorSimulatorGUI
GUI 인터페이스
```python
class SensorSimulatorGUI:
    def _create_sensor_panel(self, sensor_id: str)
    def _connect_sensor(self, sensor_id: str)
    def _start_sending(self, sensor_id: str)
```

---

## FAQ

### Q1: 센서 ID를 변경할 수 있나요?
**A**: 현재 버전은 ID 1-4 고정입니다. 추후 버전에서 사용자 정의 ID를 지원할 예정입니다.

### Q2: 사용자 정의 시나리오를 추가할 수 있나요?
**A**: 코드 수정으로 가능합니다. `_generate_sensor_data()` 메서드에 새 시나리오를 추가하세요.

### Q3: 실제 센서와 동시에 사용할 수 있나요?
**A**: 네, 가능합니다. 센서 ID만 겹치지 않으면 됩니다. 예: 실제 센서 ID 1-2, 시뮬레이터 ID 3-4

### Q4: 원격 Manager에 연결할 수 있나요?
**A**: 네, 상단 "서버 주소" 필드에 원격 IP를 입력하세요. 방화벽 설정을 확인하세요.

### Q5: 로그를 파일로 저장할 수 있나요?
**A**: 현재는 GUI에만 표시됩니다. 터미널 리디렉션으로 저장 가능합니다:
```bash
python3 sensor_simulator.py 2>&1 | tee simulator.log
```

---

## 향후 개선 계획

- [ ] 사용자 정의 센서 ID
- [ ] 시나리오 파일 로드/저장
- [ ] 자동 시나리오 전환 (타임라인)
- [ ] 센서 값 수동 입력 모드
- [ ] 로그 파일 저장 기능
- [ ] 네트워크 지연 시뮬레이션
- [ ] 센서 이상 (통신 두절) 시뮬레이션

---

## 지원

**문의**: support@garame.co.kr
**이슈 리포트**: GitHub Issues
**버전**: v2.1.0
**최종 수정**: 2026-01-28

---

Copyright © 2025 가람이엔지(주). All rights reserved.
