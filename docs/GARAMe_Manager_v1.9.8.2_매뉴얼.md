# GARAMe Manager v1.9.8.2 사용자 매뉴얼

## 목차

1. [개요](#1-개요)
2. [시스템 요구사항](#2-시스템-요구사항)
3. [설치](#3-설치)
4. [실행](#4-실행)
5. [화면 구성](#5-화면-구성)
6. [주요 기능](#6-주요-기능)
7. [설정](#7-설정)
8. [센서 연동](#8-센서-연동)
9. [키보드 단축키](#9-키보드-단축키)
10. [문제 해결](#10-문제-해결)
11. [부록](#부록)

---

## 1. 개요

### 1.1 GARAMe Manager란?

GARAMe Manager는 밀폐공간 안전 관리를 위한 **통합 모니터링 시스템**입니다.

다중 센서의 데이터를 실시간으로 수집하고, AI 기반 안전장구 감지 및 얼굴 인식을 통해 작업자의 안전을 관리합니다.

### 1.2 v1.9.8.2 주요 특징

| 기능 | 설명 |
|------|------|
| **센서 모니터링** | CO₂, O₂, H₂S, CO, LEL, 연기, 온습도, 누수 실시간 감시 |
| **5단계 경보 시스템** | 정상 → 관심 → 주의 → 경계 → 심각 단계별 경보 |
| **PPE 감지** | YOLOv10x 기반 92.7% mAP50 안전장구 감지 |
| **얼굴 인식** | InsightFace 기반 99.86% 정확도 |
| **음성 경보** | gTTS 한국어 자연스러운 음성 알림 |
| **데이터 분석** | 통계 검색, Excel/CSV 내보내기, 그래프 |

### 1.3 v1.9.8.2 신규 기능

- **안전화 감지 개선** - 듀얼 모델 구조 (construction-ppe.pt)로 슬리퍼 오인식 해결
- **PTZ 인증 개선** - Tapo 카메라 4가지 인증 방식 자동 시도
- **PTZ 계정 분리** - RTSP 로컬 계정과 Tapo 클라우드 계정 분리
- **성능 설정 UI** - 폰트 25% 축소로 컴팩트화
- **카메라 설정 시스템** - USB/IP 카메라 통합 관리
- **IP 카메라 지원** - RTSP/HTTP/HTTPS 프로토콜, Tapo C211 호환
- **PTZ 카메라 제어** - Tapo C210/C211/C220/C225 Pan/Tilt/Zoom 지원

---

## 2. 시스템 요구사항

### 2.1 필수 요구사항

| 항목 | 최소 사양 | 권장 사양 |
|------|----------|----------|
| **운영체제** | Ubuntu 18.04 LTS | Ubuntu 22.04/24.04 LTS |
| **CPU** | Intel Core i3 / AMD Ryzen 3 | Intel Core i5 / AMD Ryzen 5 |
| **RAM** | 4GB | 8GB 이상 |
| **저장공간** | 10GB | 50GB 이상 |
| **Python** | 3.8 | 3.10 ~ 3.13 |
| **화면 해상도** | 1280×720 | 1920×1080 |

### 2.2 선택 사항 (GPU 가속)

| 항목 | 권장 사양 |
|------|----------|
| **GPU** | NVIDIA GTX 1050 Ti 이상 |
| **VRAM** | 4GB 이상 |
| **CUDA** | 11.8 이상 |

> **참고**: GPU가 없어도 CPU 모드로 모든 기능이 정상 동작합니다.

### 2.3 시스템 패키지

```bash
# 필수 패키지
sudo apt install -y python3-tk python3-dev python3-venv
sudo apt install -y libgl1-mesa-glx libglib2.0-0
sudo apt install -y ffmpeg  # 음성 경보용

# 화면 캡쳐 (GNOME Wayland)
sudo apt install -y flameshot
```

---

## 3. 설치

### 3.1 배포판 설치 (권장)

```bash
# 1. 배포 파일 압축 해제
tar -xzf GARAMe_Manager_1.9.7_Ubuntu25_Distribution.tar.gz
cd GARAMe_Manager_1.9.7_Ubuntu25_Distribution

# 2. 설치 스크립트 실행
./install.sh

# GPU 가속을 사용하시겠습니까? (y/n, 기본값: n):
# - n: CPU 모드 (모든 시스템에서 작동)
# - y: GPU 가속 (NVIDIA GPU + CUDA 필요)
```

### 3.2 오프라인 설치

인터넷 연결이 없는 환경에서 사용합니다.

```bash
# wheels 폴더의 패키지를 사용한 오프라인 설치
./install_offline.sh
```

### 3.3 자동 시작 설정

부팅 시 자동으로 프로그램을 시작하려면:

```bash
./setup_autostart.sh
```

---

## 4. 실행

### 4.1 일반 실행

```bash
./run.sh
```

### 4.2 Watchdog 실행 (권장)

프로그램 비정상 종료 시 자동 재시작합니다.

```bash
./run_with_watchdog.sh
```

### 4.3 systemd 서비스

```bash
# 서비스 시작
sudo systemctl start garame-manager

# 서비스 상태 확인
sudo systemctl status garame-manager

# 부팅 시 자동 시작
sudo systemctl enable garame-manager
```

---

## 5. 화면 구성

### 5.1 메인 화면 레이아웃

```
┌─────────────────────────────────────────────────────────────┐
│  [로고]  GARAMe MANAGER              [시간] [관리자] [전체화면] │
├─────────────────────────────────────────────────────────────┤
│  [센서1] [센서2] [센서3] [센서4]  ← 센서 탭               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌─────────┐ ┌─────────┐ ┌─────────┐                     │
│   │  CO₂    │ │   O₂    │ │  H₂S   │                     │
│   │  450    │ │  20.9   │ │   0.0  │  ← 센서값 타일       │
│   │  ppm    │ │   %     │ │  ppm   │                     │
│   └─────────┘ └─────────┘ └─────────┘                     │
│                                                             │
│   ┌─────────┐ ┌─────────┐ ┌─────────┐                     │
│   │   CO    │ │  LEL    │ │  연기   │                     │
│   │    0    │ │    0    │ │   0    │                     │
│   │  ppm    │ │  %LEL   │ │   %    │                     │
│   └─────────┘ └─────────┘ └─────────┘                     │
│                                                             │
│   ┌─────────┐ ┌─────────┐ ┌─────────┐                     │
│   │  온도   │ │  습도   │ │  누수   │                     │
│   │  24.5   │ │   55    │ │  정상   │                     │
│   │   ℃    │ │  %RH   │ │        │                     │
│   └─────────┘ └─────────┘ └─────────┘                     │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  [타일] [그래프] [도면] | [거울보기] [캡쳐] | [버전: 1.9.7]    │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 표시 모드

| 모드 | 설명 | 단축키 |
|------|------|--------|
| **타일** | 센서값을 타일 형태로 표시 (기본) | - |
| **그래프** | 센서값 추이 그래프 | - |
| **도면** | 배치도 위에 센서 표시 | - |

### 5.3 센서 타일 색상

5단계 경보 시스템에 따른 색상 표시:

| 레벨 | 상태 | 색상 | 배경색 |
|------|------|------|--------|
| 1 | 정상 | 녹색 | #2ECC71 |
| 2 | 관심 | 노랑 | #F1C40F |
| 3 | 주의 | 주황 | #E67E22 |
| 4 | 경계 | 빨강 | #E74C3C |
| 5 | 심각 | 진홍 | #C0392B |

---

## 6. 주요 기능

### 6.1 센서 모니터링

#### 지원 센서

| 센서 | 단위 | 정상 범위 | 설명 |
|------|------|----------|------|
| CO₂ | ppm | ≤ 1,000 | 이산화탄소 |
| O₂ | % | 19.5 ~ 23.0 | 산소 |
| H₂S | ppm | ≤ 5 | 황화수소 |
| CO | ppm | ≤ 9 | 일산화탄소 |
| LEL | %LEL | ≤ 10 | 가연성가스 |
| 연기 | % | 0 | 연기 농도 |
| 온도 | ℃ | 18 ~ 28 | 환경 온도 |
| 습도 | %RH | 40 ~ 60 | 상대 습도 |
| 누수 | - | 정상 | 물 감지 |

#### 연결 상태

- **연결됨**: 정상 데이터 수신 중
- **대기**: 데이터 대기 중 (하트비트 수신)
- **끊김**: 연결 타임아웃 (기본 20초)

### 6.2 경보 시스템

#### 5단계 경보 레벨

| 레벨 | 설명 | 조치 |
|------|------|------|
| **정상** | 모든 센서값 정상 범위 | 정상 작업 가능 |
| **관심** | 일부 센서값 변화 | 모니터링 강화 |
| **주의** | 센서값 주의 범위 | 환기 등 조치 |
| **경계** | 센서값 위험 수준 | 즉시 조치 필요 |
| **심각** | 센서값 매우 위험 | 긴급 대피 |

#### 음성 경보

- **gTTS** (Google Text-to-Speech) 기반
- 자연스러운 한국어 여성 아나운서 목소리
- 스마트 캐시로 반복 경보 빠른 재생

### 6.3 안전장구 감지 (PPE)

#### 감지 항목

| 장구 | 감지 기능 | 가중치 |
|------|----------|--------|
| **헬멧** | 착용 여부, 색상 분석 | 40% |
| **조끼** | 착용 여부, 색상 분석 | 25% |
| **장갑** | 좌/우 구분, 개수 | 15% |
| **보안경** | 착용 여부 | 10% |
| **마스크** | 착용 여부 | 5% |
| **안전화** | 착용 여부 | 5% |

#### 색상 인식

헬멧/조끼의 색상을 자동 인식합니다:
- 흰색, 노랑, 주황, 빨강, 녹색, 파랑, 갈색 등

### 6.4 얼굴 인식

- **InsightFace** 기반 99.86% 정확도
- 등록된 작업자 자동 인식
- 이름, 사원번호, 부서, 신뢰도 표시

### 6.5 안전 교육

#### 안전 교육 흐름

```
1. 안전 포스터 확인 (사진 촬영)
   ↓
2. 서명 입력
   ↓
3. PPE 착용 확인 (자동 감지)
   ↓
4. 얼굴 인식 (신원 확인)
   ↓
5. 출입 승인
```

### 6.6 센서 통계

#### 통계 검색

메뉴: **도구 → 센서값 통계**

| 기능 | 설명 |
|------|------|
| 기간 설정 | 시작일 ~ 종료일 |
| 간격 선택 | 1분 / 10분 / 1시간 |
| 센서 선택 | 원하는 센서만 선택 |
| 결과 표시 | 최소/최대/평균/데이터 수 |

#### 내보내기

| 형식 | 내용 |
|------|------|
| **Excel (.xlsx)** | 검색결과 + 센서별 원시데이터 + 그래프 |
| **CSV (.csv)** | 검색결과 요약만 |

> **이중 Y축 그래프**: CO₂는 우측 축(ppm), 기타 센서는 좌측 축(0-100)으로 표시

### 6.7 무결성 검증

메뉴: **도구 → 무결성 검증**

해시체인 기반으로 안전교육 기록의 위변조 여부를 검증합니다.

| 상태 | 설명 |
|------|------|
| ✓ 정상 | 데이터 무결성 확인됨 |
| ✗ 위변조 | 데이터 변경 감지 |
| ? 누락 | 기록 누락 |
| ! 체인오류 | 해시체인 오류 |

### 6.8 화면 캡쳐

**캡쳐 버튼** 또는 **Ctrl+S**로 현재 화면을 저장합니다.

- 저장 위치: `~/Pictures/screenshots/`
- GNOME Wayland 환경 호환 (flameshot 사용)

---

## 7. 설정

### 7.1 설정 파일 (config.conf)

#### 기본 구조

```ini
[LISTEN]
host = 0.0.0.0
port = 9000

[UI]
tab_id_policy = by_ip
layout = tabs
tile_scale = 0.5
connection_timeout = 20.0

[ENV]
temp_min = 18.0
temp_max = 26.0
safety_education_photo = False

[AUTH]
enabled = true
users = sensor01:pass1,sensor02:pass2

[CAMERA]
device_id = 0
resolution_width = 1920
resolution_height = 1080
flip_horizontal = true
```

### 7.2 주요 설정 항목

#### [LISTEN] 섹션

| 항목 | 기본값 | 설명 |
|------|--------|------|
| host | 0.0.0.0 | 수신 IP (모든 인터페이스) |
| port | 9000 | TCP 포트 번호 |

#### [UI] 섹션

| 항목 | 기본값 | 설명 |
|------|--------|------|
| tab_id_policy | by_ip | 탭 식별 (by_ip / by_sid) |
| layout | tabs | 레이아웃 (tabs / grid) |
| tile_scale | 0.5 | 타일 크기 (0.3 ~ 0.7) |
| connection_timeout | 20.0 | 연결 타임아웃 (초) |

#### [AUTH] 섹션

| 항목 | 기본값 | 설명 |
|------|--------|------|
| enabled | false | 인증 사용 여부 |
| users | - | 센서ID:비밀번호 목록 |

#### [CAMERA] 섹션

| 항목 | 기본값 | 설명 |
|------|--------|------|
| device_id | 0 | 카메라 장치 번호 |
| resolution_width | 1920 | 해상도 너비 |
| resolution_height | 1080 | 해상도 높이 |
| flip_horizontal | true | 거울보기 (좌우 반전) |

### 7.3 관리자 모드

**F5** 키로 관리자 모드 진입 (비밀번호 필요)

관리자 기능:
- 센서 임계값 변경
- 5단계 경보 설정
- PPE 설정 변경
- 시스템 설정

---

## 8. 센서 연동

### 8.1 연결 정보

| 항목 | 값 |
|------|-----|
| 프로토콜 | TCP |
| 기본 포트 | 9000 |
| 데이터 형식 | JSON Lines |
| 인코딩 | UTF-8 |

### 8.2 메시지 형식

#### 센서 데이터 전송

```json
{
  "type": "sensor_update",
  "id": "sensor001",
  "password": "mypassword",
  "version": "1.0.0",
  "data": {
    "co2": 450,
    "o2": 20.9,
    "h2s": 0.0,
    "co": 0,
    "lel": 0,
    "smoke": 0,
    "temperature": 24.5,
    "humidity": 55.0,
    "water": 0
  }
}
```

#### 하트비트 (연결 유지)

```json
{
  "type": "heartbeat",
  "id": "sensor001"
}
```

> 권장 전송 주기: 10~30초

#### 누수 알림

```json
{
  "type": "water_leak_alert",
  "id": "sensor001",
  "password": "mypassword",
  "message": "누수가 감지되었습니다",
  "alert_level": "critical",
  "data": {"water": 1}
}
```

### 8.3 GARAMe Sensor 호환성

| 버전 | 호환성 |
|------|--------|
| v1.1.6 | ✅ 100% 호환 (권장) |
| v1.1.5 | ✅ 호환 |
| v1.1.4 | ✅ 호환 |

---

## 9. 키보드 단축키

| 단축키 | 기능 |
|--------|------|
| **F1** | 도움말 |
| **F5** | 관리자 모드 / 임계값 설정 |
| **F11** | 전체화면 토글 |
| **ESC** | 프로그램 종료 |
| **Ctrl+S** | 화면 캡쳐 |

---

## 10. 문제 해결

### 10.1 센서 연결 문제

| 증상 | 원인 | 해결 방법 |
|------|------|----------|
| 센서가 표시되지 않음 | 네트워크 문제 | IP/포트 확인, 방화벽 확인 |
| "끊김" 상태 유지 | 타임아웃 | 하트비트 주기 단축, timeout 값 증가 |
| 인증 실패 | 비밀번호 오류 | config.conf [AUTH] 설정 확인 |

### 10.2 화면 문제

| 증상 | 원인 | 해결 방법 |
|------|------|----------|
| 화면이 검게 나옴 | Wayland 문제 | flameshot 설치 확인 |
| 한글 깨짐 | 폰트 문제 | Pretendard 폰트 설치 |
| UI 멈춤 | 리소스 부족 | RAM 확인, 프로세스 재시작 |

### 10.3 카메라 문제

| 증상 | 원인 | 해결 방법 |
|------|------|----------|
| 카메라 없음 | 장치 문제 | `ls /dev/video*` 확인 |
| 검은 화면 | 권한 문제 | `sudo chmod 666 /dev/video0` |
| 좌우 반전 | 설정 문제 | flip_horizontal 설정 변경 |

### 10.4 PPE 감지 문제

| 증상 | 원인 | 해결 방법 |
|------|------|----------|
| PPE 미감지 | 모델 로딩 실패 | models/yolo10x.pt 확인 |
| 느린 감지 | CPU 모드 | GPU 사용 또는 해상도 축소 |
| 잘못된 색상 | 조명 문제 | 조명 환경 개선 |

### 10.5 로그 확인

```bash
# 런타임 로그
cat logs/run_*.log

# 센서 데이터 로그
cat logs/sensor_*.log

# 경보 이력
cat logs/alert_*.log
```

---

## 부록

### A. 5단계 경보 임계값 표

#### 이산화탄소 (CO₂)

| 레벨 | 범위 (ppm) |
|------|------------|
| 정상 | ≤ 1,000 |
| 관심 | ≤ 5,000 |
| 주의 | ≤ 10,000 |
| 경계 | ≤ 15,000 |
| 심각 | > 15,000 |

#### 산소 (O₂)

| 레벨 | 범위 (%) |
|------|----------|
| 정상 | 19.5 ~ 23.0 |
| 관심 | 19.0 ~ 23.0 |
| 주의 | 18.5 ~ 23.3 |
| 경계 | 18.0 ~ 23.5 |
| 심각 | < 18.0 또는 > 23.5 |

#### 황화수소 (H₂S)

| 레벨 | 범위 (ppm) |
|------|------------|
| 정상 | ≤ 5 |
| 관심 | ≤ 8 |
| 주의 | ≤ 10 |
| 경계 | ≤ 15 |
| 심각 | > 15 |

#### 일산화탄소 (CO)

| 레벨 | 범위 (ppm) |
|------|------------|
| 정상 | ≤ 9 |
| 관심 | ≤ 25 |
| 주의 | ≤ 30 |
| 경계 | ≤ 50 |
| 심각 | > 50 |

### B. 파일 구조

```
GARAMe_Manager_1.9.7/
├── garame_manager         # 실행 파일
├── run.sh                 # 실행 스크립트
├── config.conf            # 설정 파일
├── models/
│   └── yolo10x.pt        # PPE 감지 모델
├── assets/
│   └── fonts/            # 폰트 파일
├── safety_posters/       # 안전 포스터
├── safety_photos/        # 촬영된 사진
├── logs/                 # 로그 파일
├── export/               # 내보내기 파일
├── statistics/           # 통계 결과
└── integrity/            # 무결성 검증 결과
```

### C. TCP 연동 예제 코드

```python
import socket
import json
import time

def send_sensor_data(host, port, sensor_id, data):
    """센서 데이터 전송 예제"""
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.connect((host, port))

    msg = {
        "type": "sensor_update",
        "id": sensor_id,
        "data": data
    }

    sock.sendall((json.dumps(msg) + "\n").encode("utf-8"))
    sock.close()

# 사용 예
send_sensor_data("192.168.1.100", 9000, "sensor001", {
    "co2": 450,
    "o2": 20.9,
    "temperature": 24.5,
    "humidity": 55.0
})
```

자세한 TCP 연동 정보는 [TCP_연동_가이드.md](TCP_연동_가이드.md)를 참조하세요.

---

## 버전 정보

- **버전**: 1.9.8.2
- **릴리스**: 2024-12-24
- **플랫폼**: Ubuntu Linux 18.04+
- **Python**: 3.8 ~ 3.13

---

## 관련 문서

- [CHANGELOG_v1.9.8.2.md](CHANGELOG_v1.9.8.2.md) - 변경 이력
- [PTZ_카메라_설정_가이드.md](PTZ_카메라_설정_가이드.md) - PTZ 카메라 설정
- [안전화_모델_학습_가이드.md](안전화_모델_학습_가이드.md) - 안전화 모델 학습 방법

---

**Copyright 2024 GARAMe Project**
